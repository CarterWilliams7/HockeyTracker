<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parlay Tracker</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #0d1117; color: #fff; padding: 15px; margin: 0; }
        * { box-sizing: border-box; }

        /* INPUT SECTION */
        .controls { background: #161b22; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; }
        
        input, select, button { 
            width: 100%; padding: 12px; margin-bottom: 10px; 
            background: #0d1117; border: 1px solid #30363d; 
            color: white; border-radius: 6px; font-size: 1rem;
        }
        
        button.add-btn { background: #238636; border: none; font-weight: bold; cursor: pointer; }
        button.add-btn:active { opacity: 0.8; }

        /* SEARCH RESULTS */
        #search-results { 
            max-height: 150px; overflow-y: auto; 
            background: #21262d; border-radius: 6px; 
            display: none; margin-bottom: 10px;
        }
        .search-item { padding: 10px; border-bottom: 1px solid #30363d; cursor: pointer; }
        .search-item:hover { background: #30363d; }

        /* BET SLIP */
        .bet-card { 
            background: #161b22; border: 1px solid #30363d;
            border-radius: 8px; padding: 15px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .hit { background: rgba(35, 134, 54, 0.2); border-color: #238636; }
        
        .player-info { font-size: 1rem; font-weight: bold; }
        .bet-detail { font-size: 0.8rem; color: #8b949e; }
        .score-box { text-align: right; }
        .big-stat { font-size: 1.5rem; font-weight: 800; }
        .status-txt { font-size: 0.7rem; color: #e3b341; }
        
        .delete-btn { color: #f85149; font-size: 0.8rem; margin-top: 5px; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

    <h2 style="text-align:center; color:#58a6ff;">üèí Parlay Builder</h2>

    <div class="controls">
        <input type="text" id="playerSearch" placeholder="Search Player (e.g. Matthews)...">
        <div id="search-results"></div>

        <div id="betOptions" style="display:none;">
            <div id="selectedPlayerName" style="margin-bottom:10px; color:#58a6ff; font-weight:bold;"></div>
            
            <select id="statType">
                <option value="shots">Shots on Goal</option>
                <option value="points">Points</option>
                <option value="goals">Goals</option>
                <option value="assists">Assists</option>
            </select>
            
            <input type="number" id="statTarget" placeholder="Target (e.g. 3.5 or 1)" step="0.5">
            <button class="add-btn" onclick="addBet()">Add to Slip</button>
        </div>
    </div>

    <div id="slip-container"></div>

    <script>
        let myBets = JSON.parse(localStorage.getItem('nhl_bets')) || [];
        let selectedPlayer = null;

        // --- SEARCH LOGIC ---
        const searchInput = document.getElementById('playerSearch');
        const resultsBox = document.getElementById('search-results');

        searchInput.addEventListener('input', async (e) => {
            const query = e.target.value;
            
            // Console log to verify typing works
            console.log("Typing:", query);

            if (query.length < 3) { 
                resultsBox.style.display = 'none'; 
                return; 
            }

            try {
                // Console log to see the URL we are calling
                console.log(`Fetching: /api/search?q=${query}`);
                
                const res = await fetch(`/api/search?q=${query}`);
                
                if (!res.ok) {
                    console.error("Server Error:", res.status);
                    return;
                }

                const players = await res.json();
                console.log("Players found:", players); // See if data comes back
                
                resultsBox.innerHTML = '';
                
                if (players.length === 0) {
                     const div = document.createElement('div');
                     div.className = 'search-item';
                     div.innerText = "No players found";
                     resultsBox.appendChild(div);
                } else {
                    players.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.innerText = `${p.name} (${p.team})`;
                        div.onclick = () => selectPlayer(p);
                        resultsBox.appendChild(div);
                    });
                }
                resultsBox.style.display = 'block';

            } catch (error) {
                console.error("Fetch failed:", error);
            }
        });
        
        function selectPlayer(player) {
            selectedPlayer = player;
            document.getElementById('selectedPlayerName').innerText = `Selected: ${player.name}`;
            document.getElementById('betOptions').style.display = 'block';
            resultsBox.style.display = 'none';
            searchInput.value = '';
        }

        // --- ADD BET LOGIC ---
        function addBet() {
            if (!selectedPlayer) return;
            const type = document.getElementById('statType').value;
            const target = document.getElementById('statTarget').value;

            if (!target) { alert("Enter a target number!"); return; }

            const newBet = {
                id: Date.now(), // Unique ID
                player: selectedPlayer.name,
                team: selectedPlayer.team,
                stat: type,
                target: target,
                current: 0,
                status: 'Waiting...'
            };

            myBets.push(newBet);
            saveAndRender();
            
            // Reset UI
            document.getElementById('betOptions').style.display = 'none';
            selectedPlayer = null;
            updateLiveStats(); // Fetch data immediately
        }

        function removeBet(id) {
            myBets = myBets.filter(b => b.id !== id);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('nhl_bets', JSON.stringify(myBets));
            const container = document.getElementById('slip-container');
            container.innerHTML = '';

            myBets.forEach(bet => {
                const hitClass = bet.is_hit ? 'hit' : '';
                const html = `
                    <div class="bet-card ${hitClass}">
                        <div>
                            <div class="player-info">${bet.player}</div>
                            <div class="bet-detail">${bet.stat.toUpperCase()} ‚Ä¢ Target: ${bet.target}</div>
                            <div class="delete-btn" onclick="removeBet(${bet.id})">Remove</div>
                        </div>
                        <div class="score-box">
                            <div class="big-stat" id="score-${bet.id}">${bet.current}</div>
                            <div class="status-txt" id="status-${bet.id}">${bet.status}</div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- LIVE UPDATE LOGIC ---
        async function updateLiveStats() {
            if (myBets.length === 0) return;

            try {
                const res = await fetch('/api/track', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(myBets)
                });
                const updates = await res.json();

                // Merge updates into local myBets array to save state
                updates.forEach(u => {
                    const idx = myBets.findIndex(b => b.id === u.id);
                    if (idx !== -1) {
                        myBets[idx].current = u.current;
                        myBets[idx].status = u.status;
                        myBets[idx].is_hit = u.is_hit;
                    }
                });
                saveAndRender(); // Re-render with new colors/numbers
            } catch (e) {
                console.error("Update failed", e);
            }
        }

        // Init
        saveAndRender();
        setInterval(updateLiveStats, 15000); // Poll every 15s
        updateLiveStats(); // Run on load
    </script>
</body>
</html>